<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; 
            color: #c9d1d9; 
        }
        .container-card {
            background-color: #161b22; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .audio-player {
            width: 100%;
            height: 40px;
            background-color: #21262d;
            border-radius: 9999px; 
        }
        input[type="file"]::-webkit-file-upload-button {
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" onload="checkAuthentication()">

    <!-- Carga de Firebase SDK para la base de datos (Firestore) -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importación de funciones necesarias de Firestore
        import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        setLogLevel('Debug');
        
        // ====================================================================
        // !!! ATENCIÓN: CONFIGURACIÓN DE FIREBASE PARA SITIOS ESTÁTICOS !!!
        // ====================================================================
        // ESTA CONFIGURACIÓN HA SIDO COMPLETADA CON TUS CREDENCIALES
        // ====================================================================
        const FIREBASE_SETTINGS = {
            // App ID único para la colección de Firestore. Usa un nombre único y fijo.
            appId: "tws-music-host-v1", 
            
            // Configuración de Firebase (OBTENIDA DE TU CONSOLA)
            config: {
                apiKey: "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ", 
                authDomain: "music-host-site.firebaseapp.com", 
                projectId: "music-host-site", 
                storageBucket: "music-host-site.firebasestorage.app", 
                messagingSenderId: "761480568190",
                appId: "1:761480568190:web:0b9ff1adbe1843c86f672f"
            }
        };

        // Exportar las funciones de utilidad de Firestore al ámbito global
        window.dbHelpers = { collection, addDoc, onSnapshot, serverTimestamp };
        
        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Firebase Initialization and Authentication
        const initFirebase = async () => {
            const { appId: configAppId, config: firebaseConfig } = FIREBASE_SETTINGS;

            // 1. Verificación de configuración
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ")) {
                 // **NOTA IMPORTANTE:** Estamos asumiendo que tu clave es CORRECTA, pero si la ves en el código,
                 // el problema no es la clave en sí, sino el error de conexión.
                 // Si por alguna razón la inicialización falla, se marcará como tal.
                 if (firebaseConfig.apiKey === "TUS_API_KEY_AQUÍ") {
                     console.error("FATAL: La configuración de Firebase NO se ha actualizado. Las operaciones de DB están deshabilitadas.");
                     window.setupApp(null, null, crypto.randomUUID(), configAppId, true);
                     return;
                 }
            }
            
            try {
                // 2. Inicialización
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Autenticación (se usa autenticación anónima)
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // Pasa la instancia de DB a setupApp al completarse la autenticación
                        window.setupApp(db, auth, userId, configAppId, false); 
                    } else {
                        userId = crypto.randomUUID(); 
                        isAuthReady = true;
                        window.setupApp(null, null, userId, configAppId, true);
                    }
                });

            } catch (error) {
                // Si la configuración es incorrecta, fallará aquí con 'auth/configuration-not-found'
                console.error("Error initializing or authenticating Firebase:", error);
                userId = crypto.randomUUID(); 
                isAuthReady = true;
                // En caso de error, pasa null y marca como falla
                window.setupApp(null, null, userId, configAppId, true);
            }
        };

        window.initFirebase = initFirebase;
        // La lógica de la aplicación se inicializa después del DOMContentLoaded
    </script>
    
    <!-- 1. LOGIN SCREEN - Visible by default -->
    <section id="login-screen" class="min-h-screen flex items-center justify-center p-6">
        <div class="container-card w-full max-w-sm p-8 rounded-xl text-center">
            <h2 class="text-3xl font-bold mb-6 text-white">TWS Music Host Site</h2>
            <p class="text-gray-400 mb-6">Enter password to access the system.</p>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <input type="password" id="access-password" name="access-password" required
                           class="w-full px-4 py-3 rounded-lg bg-[#21262d] border border-[#30363d] focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-500"
                           placeholder="Enter password">
                </div>
                <button type="submit" 
                        class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition duration-200 shadow-md">
                    Access Site
                </button>
            </form>
            <div id="login-message" class="mt-4 text-sm font-medium text-red-400 hidden"></div>
        </div>
    </section>

    <!-- 2. MAIN APPLICATION CONTENT - Hidden by default -->
    <div id="main-app-content" class="hidden min-h-screen flex flex-col">
        <!-- Fixed Header -->
        <header class="bg-[#1f262e] border-b border-[#30363d] py-3 px-6 shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold text-white">TWS Music Host Site</h1>
                <nav>
                    <!-- Nav links modified to use data-section instead of href #tags for static URL -->
                    <a href="#" data-section="home" id="nav-home" class="text-blue-400 hover:text-blue-300 font-semibold mr-4">Home</a>
                    <a href="#" data-section="music-links" id="nav-links" class="text-gray-400 hover:text-white">Music Links</a>
                </nav>
            </div>
        </header>

        <!-- Main Content: Uploader (Home Tab) -->
        <main id="home" class="flex-grow flex items-center justify-center p-6">
            <div class="container-card w-full max-w-md p-8 rounded-xl">
                <h2 class="text-2xl font-semibold mb-6 text-center text-white">Upload your MP3s here</h2>
                
                <!-- User ID Displayed for debugging - AHORA SIEMPRE OCULTO -->
                <p id="user-info" class="text-xs text-center text-gray-500 mb-4 hidden">
                    User ID: Loading...
                </p>
                
                <!-- Upload Note Corrected: Bold and in English -->
                <p class="text-sm text-center text-red-400 mb-6 font-bold">
                    Note: Max. file size upload is 40MB. The use of this site is intended for RP purposes only.
                </p>

                <!-- Upload Form -->
                <form id="mp3-upload-form" class="space-y-6">

                    <!-- MP3 File Selection -->
                    <div>
                        <label for="mp3-file" class="block text-sm font-medium mb-1">Choose MP3 File</label>
                        <input type="file" id="mp3-file" name="mp3-file" accept="audio/mp3, audio/mpeg" required
                               class="w-full text-sm text-gray-400
                               file:mr-4 file:py-2 file:px-4
                               file:rounded-full file:border-0
                               file:text-sm file:font-semibold
                               file:bg-blue-600 file:text-white
                               hover:file:bg-blue-700">
                    </div>

                    <!-- Custom Name -->
                    <div>
                        <label for="custom-name" class="block text-sm font-medium mb-1">Custom Name</label>
                        <input type="text" id="custom-name" name="custom-name" required
                               class="w-full px-4 py-2 rounded-lg bg-[#21262d] border border-[#30363d] focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-500"
                               placeholder="Ex: duty calls">
                    </div>

                    <!-- Upload Button: DISABLED BY DEFAULT -->
                    <button type="submit" id="upload-button" disabled
                            class="w-full py-3 rounded-lg bg-red-900 text-white font-bold transition duration-200 shadow-md opacity-70 cursor-not-allowed">
                        DB Configuration REQUIRED
                    </button>
                </form>

                <!-- Temporary Status Message Area -->
                <div id="status-message" class="mt-4 text-center text-sm font-medium hidden"></div>

                <!-- Hidden Activity Log (Internal Log) -->
                <div class="mt-6 pt-4 border-t border-[#30363d] hidden">
                    <h3 class="text-sm font-semibold mb-2 text-gray-400">Activity/Error Log</h3>
                    <div id="activity-log" class="max-h-40 overflow-y-auto space-y-1 p-2 rounded-lg bg-[#21262d] text-xs flex flex-col-reverse">
                        <p class="text-gray-500">Application log initialized.</p>
                    </div>
                </div>

            </div>
        </main>

        <!-- Music Links Section (Music Links Tab) -->
        <section id="music-links" class="hidden flex-grow flex justify-center p-6">
            <div class="container-card w-full max-w-4xl p-8 rounded-xl h-full flex flex-col">
                <h2 class="text-2xl font-semibold mb-6 text-center text-white">Uploaded Music Links</h2>
                <p id="song-count" class="text-sm text-gray-500 mb-4 text-center">Total: Loading...</p>
                
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-center">
                    <input type="text" id="search-input" placeholder="Search song by name..."
                        class="w-full sm:flex-grow px-4 py-2 rounded-lg bg-[#21262d] border border-[#30363d] text-white placeholder-gray-500 mb-4 sm:mb-0 sm:mr-4">
                    <div class="flex space-x-4 text-sm whitespace-nowrap">
                        <label><input type="radio" name="sort" value="alpha" id="sort-alpha" class="mr-1"> Alphabetical</label>
                        <label><input type="radio" name="sort" value="newest" id="sort-newest" checked class="mr-1"> Newest</label>
                        <label><input type="radio" name="sort" value="oldest" id="sort-oldest" class="mr-1"> Oldest</label>
                    </div>
                </div>
                
                <!-- Container where the actual music list will be rendered -->
                <div id="music-list" class="space-y-3 flex-grow overflow-y-auto pr-2">
                    <!-- List elements will be injected here by JavaScript -->
                    <p id="list-status" class="text-center text-gray-500">Loading music links...</p>
                </div>

            </div>
        </section>
        
        <!-- Fixed Footer -->
        <footer class="bg-[#1f262e] border-t border-[#30363d] py-3 px-6 text-center text-xs text-gray-500">
            &copy; 2025-2026 Made by Rorale. All rights reserved. Hosted for the TWS Enforcement Bureau Team
        </footer>
    </div>


    <!-- Main JavaScript logic for application handling -->
    <script>
        // --- AUTHENTICATION CONSTANT ---
        const SECRET_PASSWORD = "jawoHL_66";
        
        // Global Firebase variables (will be populated in initFirebase)
        let dbInstance = null;
        let userId = null;
        let appId = null;
        let statusTimeout = null;
        
        const MAX_FILE_SIZE = 40 * 1024 * 1024; 

        // CLOUDINARY CONFIGURATION (Confirmed values)
        const CLOUDINARY_CLOUD_NAME = "daj3jaqd9"; 
        const CLOUDINARY_UPLOAD_PRESET = "tws_music_uploads"; 
        const PUBLIC_MUSIC_COLLECTION_PATH = 'public/data/music_links'; 

        // --- AUTHENTICATION & URL CLEANUP LOGIC ---
        
        // Función para limpiar la barra de URL. Envuelto en try...catch para evitar SecurityError en entornos blob:
        function cleanUrl() {
            try {
                // Intenta limpiar la URL eliminando fragmentos (hashes) y asegurando el path base.
                history.replaceState(null, '', window.location.pathname + window.location.search);
            } catch (e) {
                // Ignorar SecurityError ya que es común en entornos seguros (como iframe con blob: URL).
                if (e.name === 'SecurityError') {
                    console.warn("SecurityError: No se pudo modificar el historial URL en este contexto seguro. Limpieza omitida.");
                } else {
                    console.error("Error inesperado al limpiar la URL:", e);
                }
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const inputPassword = document.getElementById('access-password').value;
            const loginMessage = document.getElementById('login-message');
            
            if (inputPassword === SECRET_PASSWORD) {
                loginMessage.classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                
                cleanUrl();
                
                sessionStorage.setItem('tws_music_authenticated', 'true'); 
                
                // Inicializar Firebase SÓLO después de la autenticación exitosa
                // La función initFirebase ya fue definida en el script type="module" y puesta en window
                window.initFirebase(); 
                
            } else {
                loginMessage.textContent = 'Invalid Password. Access Denied.';
                loginMessage.classList.remove('hidden');
                document.getElementById('access-password').value = '';
                document.getElementById('access-password').focus();
            }
        }
        
        function checkAuthentication() {
            cleanUrl();
            
            if (sessionStorage.getItem('tws_music_authenticated') === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app-content').classList.remove('hidden');
                // Si ya está autenticado, inicializa Firebase de inmediato
                if (window.initFirebase) {
                    window.initFirebase(); 
                } else {
                    displayStatus('FATAL: Firebase init function is not available. Check module script loading.', 'error', 0);
                }

            } else {
                // Si no está autenticado, espera el evento de inicio de sesión antes de inicializar Firebase
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                displayStatus('Please log in to access the system.', 'info', 0);
            }
        }
        // --- END AUTHENTICATION & URL CLEANUP LOGIC ---

        // NEW: This function is called once Firebase Auth is resolved and DB instance is available
        window.setupApp = (db, auth, uid, app_id, isFailed) => {
            dbInstance = db;
            userId = uid;
            appId = app_id;
            
            const uploadButton = document.getElementById('upload-button');
            const userInfo = document.getElementById('user-info'); // Referencia al elemento de ID de usuario
            
            // La línea para mostrar el ID de usuario permanece oculta a petición del usuario.
            userInfo.textContent = `User ID: ${userId}`;

            if (dbInstance && !isFailed) {
                // Conexión a DB exitosa
                uploadButton.disabled = false;
                uploadButton.classList.remove('opacity-70', 'cursor-not-allowed', 'bg-red-900');
                uploadButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                uploadButton.textContent = 'Upload';
                displayStatus('Database connection established. You can now upload files.', 'success', 3000);
                setupMusicListener();

            } else {
                // Conexión a DB fallida (Configuración faltante/inválida o error de autenticación)
                uploadButton.disabled = true;
                uploadButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                uploadButton.classList.add('bg-red-900', 'opacity-70', 'cursor-not-allowed');
                
                let errorMsg = `FATAL: Database Error. Uploads and listing are disabled.`;
                
                // Si dbInstance es nulo y la clave fue correctamente insertada (revisando la variable global)
                if (FIREBASE_SETTINGS.config.apiKey.includes("AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ")) {
                    uploadButton.textContent = 'DB Connection Failed: Check Console';
                    errorMsg = `FATAL: Database connection failed. Check your Firebase credentials and rules in the console. App ID: ${appId}`;
                } else {
                    // Este caso solo debería ocurrir si no se ha actualizado la clave o hay un error de carga
                    uploadButton.textContent = 'DB Configuration MISSING';
                    errorMsg = `FATAL: Database configuration is missing. Please update FIREBASE_SETTINGS in the JavaScript block.`;
                }

                const dbStatusMessage = document.getElementById('status-message');
                dbStatusMessage.textContent = errorMsg;
                dbStatusMessage.classList.remove('hidden');
                dbStatusMessage.className = 'mt-4 p-3 rounded-lg text-center text-sm font-bold border bg-red-900 text-red-300 border-red-700';
                
                console.error(`FIREBASE ERROR: Database instance is NULL. Reason: ${errorMsg}`);
            }
            
            // Inicializa la lógica de la aplicación (navegación, listeners, etc.)
            initAppLogic();
        };

        function displayStatus(message, type = 'info', duration = 5000) { 
            clearTimeout(statusTimeout);
            const statusMessage = document.getElementById('status-message');
            const logContainer = document.getElementById('activity-log');

            // --- 1. Temporary Status Bar ---
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');

            let colorClass = '';
            
            switch(type) {
                case 'error':
                    colorClass = 'bg-red-900 text-red-300 border-red-700';
                    duration = 0; 
                    break;
                case 'success':
                    colorClass = 'bg-green-900 text-green-300 border-green-700';
                    break;
                case 'loading':
                    colorClass = 'bg-blue-900 text-blue-300 border-blue-700';
                    duration = 0; 
                    break;
                default:
                    colorClass = 'bg-gray-700 text-gray-300 border-gray-600';
            }
            
            statusMessage.className = `mt-4 p-3 rounded-lg text-center text-sm font-medium border ${colorClass}`;
            
            if (duration > 0) {
                statusTimeout = setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, duration);
            }
            
            // --- 2. Persistent Log (still populating, though hidden for UI) ---
            const logEntry = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();
            
            let logColorClass = 'text-gray-400';
            let prefix = 'INFO';

            switch(type) {
                case 'error':
                    logColorClass = 'text-red-300';
                    prefix = 'ERROR';
                    console.error(`[LOG] ${timestamp} ${message}`);
                    break;
                case 'success':
                    logColorClass = 'text-green-300';
                    prefix = 'SUCCESS';
                    break;
                case 'loading':
                    logColorClass = 'text-blue-300';
                    prefix = 'LOAD';
                    break;
                default:
                    logColorClass = 'text-gray-400';
                    prefix = 'INFO';
            }
            
            logEntry.className = logColorClass;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}] [${prefix}]</span> ${message}`; 
            
            logContainer.prepend(logEntry);
            
            if (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }

        }
        
        function renderMusicItem(item) {
            const div = document.createElement('div');
            div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-[#21262d] p-3 rounded-lg border border-[#30363d]';
            
            const infoContainer = document.createElement('div');
            infoContainer.className = 'flex flex-col w-full sm:w-2/3 mb-2 sm:mb-0';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'truncate text-white font-medium mb-2';
            titleSpan.textContent = item.customName || 'Unassigned Name';
            
            const audioPlayer = document.createElement('audio');
            audioPlayer.controls = true;
            audioPlayer.src = item.sharedUrl;
            audioPlayer.className = 'audio-player';

            infoContainer.appendChild(titleSpan);
            infoContainer.appendChild(audioPlayer);

            const copyButton = document.createElement('button');
            copyButton.className = 'copy-link-btn w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded-full transition duration-200 mt-2 sm:mt-0';
            copyButton.textContent = 'Copy Link';
            copyButton.dataset.url = item.sharedUrl; 

            div.appendChild(infoContainer);
            div.appendChild(copyButton);
            
            return div;
        }

        // Firestore Listener Logic 
        function setupMusicListener() {
            if (!dbInstance) {
                // Ya manejado por setupApp, solo muestra el estado en la pestaña
                document.getElementById('list-status').textContent = 'Error: Database is not configured or available. Cannot fetch music links.';
                return;
            }
            
            // Obtener funciones de utilidad de Firestore
            const { collection, onSnapshot } = window.dbHelpers;
            
            const musicListContainer = document.getElementById('music-list');
            // Usamos el appId definido en FIREBASE_SETTINGS
            const collectionRef = collection(dbInstance, 'artifacts', appId, PUBLIC_MUSIC_COLLECTION_PATH);
            
            // Consulta de Firestore (ordenar por descendente de forma predeterminada, ordenar en cliente después de la búsqueda)
            let songs = [];
            const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                songs = [];
                const searchTerm = document.getElementById('search-input').value.toLowerCase();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const customName = (data.customName || '').toLowerCase();
                    
                    // Filtrado de búsqueda
                    if (data.sharedUrl && (searchTerm === '' || customName.includes(searchTerm))) {
                        songs.push({ id: doc.id, ...data });
                    }
                });

                document.getElementById('song-count').textContent = `Total: ${songs.length} songs`;

                if (songs.length === 0) {
                    musicListContainer.innerHTML = `<p class="text-center text-gray-500">${searchTerm ? 'No songs match your search.' : 'No songs have been uploaded yet.'}</p>`;
                    return;
                }
                
                // --- Lógica de ordenación manual ---
                const sortType = document.querySelector('input[name="sort"]:checked').value;
                
                if (sortType === 'alpha') {
                    songs.sort((a, b) => (a.customName || '').localeCompare(b.customName || ''));
                } else if (sortType === 'oldest') {
                    // Ordenar por timestamp (asc)
                    songs.sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                } else if (sortType === 'newest') {
                    // Ordenar por timestamp (desc)
                    songs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                }

                musicListContainer.innerHTML = ''; // Limpiar lista
                songs.forEach(song => {
                    musicListContainer.appendChild(renderMusicItem(song));
                });
                // --- Fin Ordenación ---

                setupCopyButtons();
                displayStatus(`${songs.length} songs list updated.`, 'info', 2000);
            }, (error) => {
                console.error("Error listening to music list:", error);
                document.getElementById('list-status').textContent = 'Error loading music list. Check permissions.';
                displayStatus(`Firestore Error: Failed to subscribe to music list.`, 'error');
            });
            
            return unsubscribe;
        }
        
        // Function to save the link to Firestore
        async function saveLinkToFirestore(customName, sharedUrl) {
            if (!dbInstance) {
                 displayStatus('Error: Database is not ready to save.', 'error');
                 return false;
            }
            
            // Obtener funciones de utilidad de Firestore
            const { collection, addDoc, serverTimestamp } = window.dbHelpers;
            
            try {
                // Usamos el appId definido en FIREBASE_SETTINGS
                const path = collection(dbInstance, 'artifacts', appId, PUBLIC_MUSIC_COLLECTION_PATH);
                await addDoc(path, {
                    customName: customName,
                    sharedUrl: sharedUrl,
                    uploadedBy: userId, 
                    createdAt: serverTimestamp() 
                });
                displayStatus(`Successfully saved to Firestore. Name: ${customName}`, 'success', 3000); 
                return true;
            } catch (error) {
                console.error("Error saving link to Firestore:", error);
                displayStatus(`Error saving link to DB: ${error.message}`, 'error');
                return false;
            }
        }

        // Función para re-habilitar el botón de subida a su estado normal
        function enableUploadButton(uploadButton) {
            uploadButton.disabled = false;
            uploadButton.classList.remove('opacity-50', 'cursor-not-allowed');
            // Re-añade la clase hover para el efecto visual
            uploadButton.classList.add('hover:bg-blue-700');
        }

        // Cloudinary Upload Logic
        async function handleUpload(e) {
            e.preventDefault();
            
            const uploadButton = document.getElementById('upload-button');

            // Final safety check, though button should be disabled if not ready
            if (!dbInstance) {
                 displayStatus('Error: Database is not ready. Uploads are disabled.', 'error');
                 enableUploadButton(uploadButton); // Asegura que se habilite
                 return;
            }

            if (CLOUDINARY_CLOUD_NAME === "" || CLOUDINARY_UPLOAD_PRESET === "") {
                 displayStatus('ERROR: Cloudinary configuration is incomplete. Check constants.', 'error');
                 enableUploadButton(uploadButton); // Asegura que se habilite
                 return;
            }
            
            const fileInput = document.getElementById('mp3-file');
            const customNameInput = document.getElementById('custom-name');
            const file = fileInput.files[0];
            const customName = customNameInput.value.trim();
            
            if (!file) {
                displayStatus('Validation: Please select an MP3 file.', 'error');
                enableUploadButton(uploadButton); // Asegura que se habilite
                return;
            }
            if (!customName) {
                 displayStatus('Validation: Please enter a custom name.', 'error');
                 enableUploadButton(uploadButton); // Asegura que se habilite
                 return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                 displayStatus(`Error: File is too large. Maximum ${MAX_FILE_SIZE / (1024 * 1024)} MB.`, 'error');
                 enableUploadButton(uploadButton); // Asegura que se habilite
                 return;
            }
            if (!file.type.startsWith('audio/')) {
                 displayStatus('Error: Only audio files are allowed.', 'error');
                 enableUploadButton(uploadButton); // Asegura que se habilite
                 return;
            }

            // Deshabilitar botón de subida
            displayStatus('Uploading file, please wait...', 'loading');
            uploadButton.disabled = true;
            uploadButton.classList.add('opacity-50', 'cursor-not-allowed');
            uploadButton.classList.remove('hover:bg-blue-700');

            try {
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                // Creación de public_id seguro usando el nombre y el timestamp
                formData.append('public_id', `music/${customName.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}`); 
                formData.append('resource_type', 'auto'); 
                
                const apiUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const sharedUrl = data.secure_url; 
                    displayStatus(`Cloudinary: Upload complete. Saving link...`, 'loading');
                    
                    const saved = await saveLinkToFirestore(customName, sharedUrl);

                    if (saved) {
                         displayStatus(`Success! Upload and save successful.`, 'success');
                         document.getElementById('mp3-upload-form').reset();
                    }

                } else {
                    displayStatus(`Cloudinary Upload Error: ${data.error ? data.error.message : 'Unknown error'}`, 'error');
                    console.error("Cloudinary response error:", data);
                }

            } catch (error) {
                displayStatus(`Network or Connection Error: ${error.message}`, 'error');
                console.error("Upload error:", error);
            } finally {
                // *** FIX: Asegurar que el botón se rehabilita al finalizar el try/catch ***
                enableUploadButton(uploadButton);
            }
        }
        
        function setupCopyButtons() {
            document.querySelectorAll('.copy-link-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const urlToCopy = button.dataset.url;
                    
                    const textarea = document.createElement('textarea');
                    textarea.value = urlToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        // Usar document.execCommand('copy') por restricciones de iframe
                        document.execCommand('copy');
                        displayStatus('Link copied to clipboard: ' + urlToCopy.substring(0, 50) + '...', 'success', 3000);
                    } catch (err) {
                        displayStatus('Error attempting to copy link.', 'error');
                    }
                    document.body.removeChild(textarea);
                });
            });
        }

        // Tab Navigation Logic
        const showSection = (id) => {
            document.getElementById('home').classList.add('hidden');
            document.getElementById('music-links').classList.add('hidden');
            
            if (id === 'home') {
                document.getElementById('home').classList.remove('hidden');
            } else if (id === 'music-links') {
                document.getElementById('music-links').classList.remove('hidden');
                // Al ingresar a Music Links, asegura que el listener esté activo
                // Esto también gestiona el caso de que la DB esté desactivada
                if (dbInstance) {
                    setupMusicListener(); 
                } else {
                    document.getElementById('list-status').textContent = 'Error: Database is not configured or available. Cannot fetch music links.';
                }
            }
            
            cleanUrl();

            // Update the active class in the navigation
            const navLinks = document.querySelectorAll('header nav a');
            navLinks.forEach(link => {
                link.classList.remove('text-blue-400', 'font-semibold', 'hover:text-blue-300');
                link.classList.add('text-gray-400', 'hover:text-white');
                if (link.dataset.section === id) {
                    link.classList.add('text-blue-400', 'font-semibold', 'hover:text-blue-300');
                    link.classList.remove('text-gray-400', 'hover:text-white');
                }
            });
        };

        function initAppLogic() {
            // Conectar el formulario a la función de subida
            document.getElementById('mp3-upload-form').addEventListener('submit', handleUpload);

            // Manejar clics en enlaces de navegación
            const navLinks = document.querySelectorAll('header nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.dataset.section;
                    showSection(sectionId);
                });
            });

            // Manejar cambios de ordenación/búsqueda
            const sortingInputs = document.querySelectorAll('input[name="sort"], #search-input');
            sortingInputs.forEach(input => {
                input.addEventListener('change', () => {
                    if (document.getElementById('music-links').classList.contains('hidden') === false) {
                        setupMusicListener();
                    }
                });
                if (input.id === 'search-input') {
                    // Usar evento 'input' para un filtrado en tiempo real
                     input.addEventListener('input', () => {
                        if (document.getElementById('music-links').classList.contains('hidden') === false) {
                            setupMusicListener();
                        }
                    });
                }
            });

            // Mostrar la página de inicio por defecto
            showSection('home');
        }
        
        // Iniciar el proceso: comprueba si está autenticado o muestra el login
        document.addEventListener('DOMContentLoaded', checkAuthentication);
    </script>
</body>
</html>
