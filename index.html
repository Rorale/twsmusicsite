<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site - Upload & Share</title>
    <!-- Carga de Tailwind CSS para el estilizado -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Paleta de colores Oscura */
        :root {
            --color-bg-light: #1f2937; /* Fondo oscuro principal */
            --color-bg-card: #374151; /* Fondo de tarjetas/secundario */
            --color-text: #f3f4f6; /* Texto claro */
            --color-input-bg: #4b5563; /* Fondo de inputs */
            --color-primary: #3b82f6; /* Azul brillante para acciones (Upload) */
            --color-primary-hover: #2563eb;
            --color-secondary: #10b981; /* Verde para éxito/copiar */
            --color-danger: #ef4444; /* Rojo para errores/eliminar */
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-light); 
            color: var(--color-text); 
        }
        .container { max-width: 90%; margin: 0 auto; padding: 20px; }
        .card { 
            background-color: var(--color-bg-card); 
            border: 1px solid #4b5563; /* Borde sutil */
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .input-style { 
            background-color: var(--color-input-bg); 
            border: 1px solid #6b7280; 
            color: var(--color-text);
            border-radius: 8px;
        }
        /* Botones de acción */
        .btn-primary { background-color: var(--color-primary); color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: var(--color-primary-hover); }
        .btn-danger { background-color: var(--color-danger); color: white; cursor: not-allowed; transition: background-color 0.2s; }
        .btn-danger:hover { background-color: #dc2626; }

        /* Player styles */
        audio::-webkit-media-controls-panel { background-color: #4b5563; border-radius: 8px; }
        audio { height: 40px; } /* Ajuste de altura */

        /* Estilo para las tarjetas de canciones */
        .song-item {
            border: 1px solid #4b5563;
            border-radius: 8px;
            background-color: #4b5563; /* Más oscuro que el fondo principal para destacar */
            transition: box-shadow 0.2s;
        }
        .song-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="min-h-screen p-4">

    <!-- Navbar -->
    <header class="flex justify-between items-center py-4 border-b border-gray-600 mb-6">
        <h1 class="text-3xl font-extrabold text-gray-100">TWS Music Host Site</h1>
        <nav>
            <a href="#upload" class="text-blue-400 hover:text-blue-300 mx-2 font-medium">Home</a>
            <a href="#links" class="text-blue-400 hover:text-blue-300 mx-2 font-medium">Music Links</a>
        </nav>
    </header>

    <!-- Contenedor Principal -->
    <div class="lg:flex lg:space-x-8">

        <!-- Columna de Carga (Upload) -->
        <div id="upload" class="w-full lg:w-1/2 p-6 card mb-8 lg:mb-0">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Upload your MP3s here</h2>

            <!-- Mensaje de error/éxito -->
            <div id="upload-status" class="hidden p-3 rounded-lg text-sm mb-4 font-semibold" role="alert"></div>

            <form id="uploadForm" class="space-y-6">
                <p class="text-red-400 text-sm font-semibold">
                    Note: Max. file size upload is 40MB. The use of this site is intended for RP purposes only.
                </p>

                <!-- Campo de archivo -->
                <div>
                    <label for="mp3File" class="block text-sm font-medium mb-1 text-gray-300">Choose MP3 File</label>
                    <input type="file" id="mp3File" accept="audio/mp3" required class="input-style p-3 w-full rounded-lg cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-800 file:text-blue-200 hover:file:bg-blue-700">
                </div>

                <!-- Campo de nombre personalizado -->
                <div>
                    <label for="customName" class="block text-sm font-medium mb-1 text-gray-300">Custom Name</label>
                    <input type="text" id="customName" placeholder="Ex: duty calls" class="input-style p-3 w-full rounded-lg">
                </div>
                
                <!-- Botón de Carga/Estado DB -->
                <button type="submit" id="uploadButton" class="w-full py-3 rounded-lg font-bold text-lg btn-danger" disabled>
                    DB Configuration REQUIRED
                </button>

                <!-- Mensaje de inicio de sesión -->
                <div id="login-status-message" class="text-center text-sm text-gray-400 py-2 rounded-md">
                    Please log in to access the system.
                </div>
            </form>
        </div>

        <!-- Columna de Enlaces de Música (Music Links) -->
        <div id="links" class="w-full lg:w-1/2 p-6 card">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-100">Uploaded Music Links</h2>
            
            <div id="loading-spinner" class="hidden text-center py-10">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-t-4 border-blue-400 border-opacity-25 rounded-full"></div>
                <p class="text-blue-400 mt-2">Cargando canciones...</p>
            </div>

            <!-- Contador de canciones -->
            <p class="text-right text-gray-400 mb-4">Total: <span id="song-count" class="font-bold">0</span> songs</p>

            <!-- Filtros y Búsqueda -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="search-input" placeholder="Search song by name..." class="input-style p-3 rounded-lg w-full sm:w-2/3">
                <div class="flex space-x-2 text-sm text-gray-300 font-medium">
                    <label><input type="radio" name="sort" value="alpha" checked class="text-blue-400"> Alphabetical</label>
                    <label><input type="radio" name="sort" value="newest" class="text-blue-400"> Newest</label>
                    <label><input type="radio" name="sort" value="oldest" class="text-blue-400"> Oldest</label>
                </div>
            </div>

            <!-- Lista de Canciones -->
            <div id="music-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Las canciones se inyectarán aquí -->
                <div id="no-songs-message" class="text-center text-gray-500 mt-10 hidden">
                    No hay canciones subidas todavía. ¡Sube la primera!
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="mt-8 pt-4 text-center text-sm text-gray-400 border-t border-gray-600">
        &copy; 2025 by Rorale. All rights reserved.
    </footer>

    <!-- Bibliotecas de Firebase y Storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuración Global y Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Variables de Firebase
        let app, db, auth, storage, userId = null;
        let isAuthReady = false;

        // --- INICIO DE CONFIGURACIÓN DE FIREBASE ---
        const FIREBASE_SETTINGS = {
            // Este objeto DEBE contener la configuración real de tu proyecto
            config: {
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                // !!! LA CLAVE API HA SIDO INSERTADA CORRECTAMENTE !!!
                // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                apiKey: "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ", 
                authDomain: "music-host-site.firebaseapp.com",
                projectId: "music-host-site",
                storageBucket: "music-host-site.appspot.com",
                messagingSenderId: "761480568190",
                appId: "1:761480568190:web:0b9ff1adbe1843c86f672f"
            },
            storageCollection: 'uploaded_songs'
        };
        // --- FIN DE CONFIGURACIÓN DE FIREBASE ---

        // Función para obtener la configuración final (prioriza la inyectada por el entorno)
        function getFirebaseConfig() {
            try {
                const envConfig = JSON.parse(firebaseConfigRaw);
                // Si la configuración del entorno es válida y tiene apiKey, la usamos.
                if (envConfig && envConfig.apiKey && envConfig.apiKey.length > 30 && envConfig.apiKey !== FIREBASE_SETTINGS.config.apiKey) {
                    return envConfig;
                }
            } catch (e) {
                console.error("Error al parsear la configuración de Firebase del entorno:", e);
            }
            // Usamos la configuración manual si el entorno no proporcionó una válida.
            return FIREBASE_SETTINGS.config;
        }

        // Elementos del DOM
        const uploadButton = document.getElementById('uploadButton');
        const uploadStatus = document.getElementById('upload-status');
        const uploadForm = document.getElementById('uploadForm');
        const musicList = document.getElementById('music-list');
        const songCountElement = document.getElementById('song-count');
        const loginStatusMessage = document.getElementById('login-status-message');
        const searchInput = document.getElementById('search-input');
        const sortRadios = document.querySelectorAll('input[name="sort"]');
        const noSongsMessage = document.getElementById('no-songs-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Estado de la interfaz
        let allSongs = [];
        let filteredSongs = [];

        // Inicialización de Firebase
        async function initFirebase() {
            const config = getFirebaseConfig();
            
            // Verificación de la Clave API (El error que estás viendo)
            if (config.apiKey === "AIzaSyBipp_qEAamELRQJDGz7wWb6LUDyj7-cRQ") {
                // Ya no mostramos este error porque la clave ya fue insertada.
                // Sin embargo, si la configuración del entorno no está, usamos la que insertaste.
            }

            try {
                // Desactivar el botón de subida hasta que la autenticación esté lista
                uploadButton.textContent = "Connecting to DB...";
                uploadButton.disabled = true;

                // Inicializar servicios
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                setLogLevel('error'); // Configurar el nivel de log

                // Autenticación
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener de estado de autenticación (Necesario para obtener el userId)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        loginStatusMessage.textContent = `User ID: ${userId.substring(0, 10)}... (Logged in)`;
                        loginStatusMessage.className = 'text-center text-sm text-green-400 py-2 rounded-md font-medium';
                        uploadButton.textContent = "Upload";
                        uploadButton.classList.remove('btn-danger');
                        uploadButton.classList.add('btn-primary');
                        uploadButton.disabled = false;
                        
                        // Una vez autenticado, iniciamos el listener de Firestore
                        setupFirestoreListener();
                    } else {
                        // Si el usuario no está autenticado (debería ser raro en este entorno)
                        isAuthReady = true;
                        userId = null;
                        loginStatusMessage.textContent = "Please log in to access the system.";
                        loginStatusMessage.className = 'text-center text-sm text-gray-400 py-2 rounded-md';
                        uploadButton.textContent = "DB Configuration REQUIRED";
                        uploadButton.classList.add('btn-danger');
                        uploadButton.classList.remove('btn-primary');
                        uploadButton.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                uploadButton.textContent = "DB Failed. Check Console.";
                uploadButton.classList.remove('btn-primary');
                uploadButton.classList.add('btn-danger');
                uploadButton.disabled = true;
                loginStatusMessage.textContent = "FATAL: Database instance is NULL after setup.";
                loginStatusMessage.className = 'text-center text-sm text-red-400 py-2 rounded-md font-medium';
            }
        }

        // Listener de Firestore (Datos Públicos)
        function setupFirestoreListener() {
            if (!db || !userId) return;

            loadingSpinner.classList.remove('hidden');
            musicList.innerHTML = '';
            
            // La colección pública para compartir música
            const collectionPath = `artifacts/${appId}/public/data/${FIREBASE_SETTINGS.storageCollection}`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                loadingSpinner.classList.add('hidden');
                allSongs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allSongs.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0) // Convertir timestamp
                    });
                });
                
                // Aplicar filtros y ordenación al recibir nuevos datos
                filterAndSortSongs();
            }, (error) => {
                console.error("Error fetching songs:", error);
                loadingSpinner.classList.add('hidden');
            });
        }

        // Lógica de filtrado y ordenación
        function filterAndSortSongs() {
            let tempSongs = [...allSongs];
            const searchTerm = searchInput.value.toLowerCase();
            const sortOrder = document.querySelector('input[name="sort"]:checked').value;

            // 1. Filtrado
            if (searchTerm) {
                tempSongs = tempSongs.filter(song => 
                    song.name.toLowerCase().includes(searchTerm) || 
                    song.fileName.toLowerCase().includes(searchTerm)
                );
            }
            
            // 2. Ordenación
            if (sortOrder === 'alpha') {
                tempSongs.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortOrder === 'newest') {
                tempSongs.sort((a, b) => b.timestamp - a.timestamp);
            } else if (sortOrder === 'oldest') {
                tempSongs.sort((a, b) => a.timestamp - b.timestamp);
            }

            filteredSongs = tempSongs;
            renderMusicList(filteredSongs);
        }

        // Renderizado de la lista
        function renderMusicList(songs) {
            musicList.innerHTML = '';
            songCountElement.textContent = songs.length;
            
            if (songs.length === 0) {
                noSongsMessage.classList.remove('hidden');
            } else {
                noSongsMessage.classList.add('hidden');
                songs.forEach(song => {
                    const songElement = createSongElement(song);
                    musicList.appendChild(songElement);
                });
            }
        }

        // Creación de elemento de canción
        function createSongElement(song) {
            const div = document.createElement('div');
            div.className = 'song-item p-3 flex flex-col md:flex-row justify-between items-center';
            div.id = `song-${song.id}`;

            const name = song.name || song.fileName;
            const link = window.location.origin + window.location.pathname + `?file=${encodeURIComponent(song.path)}`;

            div.innerHTML = `
                <div class="flex-grow w-full md:w-auto mb-3 md:mb-0">
                    <p class="font-semibold text-lg text-gray-100">${name}</p>
                    <p class="text-xs text-gray-400">Owner: ${song.ownerId ? song.ownerId.substring(0, 8) : 'Unknown'}</p>
                    <audio controls class="w-full mt-2"></audio>
                </div>
                <div class="flex space-x-2 mt-3 md:mt-0">
                    <button data-link="${link}" class="copy-btn px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg text-sm font-medium transition duration-150">
                        Copy Link
                    </button>
                    ${song.ownerId === userId ? `
                    <button data-id="${song.id}" data-path="${song.path}" class="delete-btn px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-medium transition duration-150">
                        Delete
                    </button>` : ''}
                </div>
            `;
            // Establecer la fuente de audio por separado para evitar problemas de CSP
            div.querySelector('audio').src = song.url;
            return div;
        }

        // Manejador de eventos para el formulario de subida
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !storage || !userId) {
                displayStatus('FATAL: Database is not connected.', 'bg-red-500');
                return;
            }

            const fileInput = document.getElementById('mp3File');
            const customNameInput = document.getElementById('customName');
            const file = fileInput.files[0];

            if (!file) {
                displayStatus('Please select an MP3 file to upload.', 'bg-red-500');
                return;
            }

            if (file.size > 40 * 1024 * 1024) {
                 displayStatus('Error: File size exceeds the 40MB limit.', 'bg-red-500');
                 return;
            }

            const fileName = customNameInput.value || file.name.replace(/\.[^/.]+$/, "");
            const fileExtension = file.name.split('.').pop();
            const storagePath = `artifacts/${appId}/public/audio/${crypto.randomUUID()}.${fileExtension}`;
            
            uploadButton.textContent = "Uploading...";
            uploadButton.disabled = true;

            try {
                // 1. Subir a Firebase Storage
                const sRef = storageRef(storage, storagePath);
                const uploadTask = await uploadBytes(sRef, file);
                const downloadURL = await getDownloadURL(uploadTask.ref);

                // 2. Guardar metadata en Firestore (Colección pública)
                const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/${FIREBASE_SETTINGS.storageCollection}`), {
                    name: fileName,
                    fileName: file.name,
                    url: downloadURL,
                    path: storagePath, // Necesario para eliminar
                    ownerId: userId,
                    timestamp: new Date()
                });

                displayStatus(`Success! Song "${fileName}" uploaded and link generated.`, 'bg-green-500');
                uploadForm.reset();
            } catch (error) {
                console.error("Upload/Firestore Error:", error);
                displayStatus(`Error uploading file: ${error.message}`, 'bg-red-500');
            } finally {
                uploadButton.textContent = "Upload";
                uploadButton.disabled = false;
            }
        });

        // Manejador de eventos para borrar y copiar
        musicList.addEventListener('click', async (e) => {
            // Copiar enlace
            if (e.target.classList.contains('copy-btn')) {
                const link = e.target.dataset.link;
                try {
                    // Usar document.execCommand('copy') como fallback para iframes
                    const textarea = document.createElement('textarea');
                    textarea.value = link;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    e.target.textContent = 'Copied!';
                    setTimeout(() => { e.target.textContent = 'Copy Link'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy link:', err);
                }
            }

            // Eliminar canción
            if (e.target.classList.contains('delete-btn')) {
                const songId = e.target.dataset.id;
                const storagePath = e.target.dataset.path;
                
                // Usar un modal simple para confirmación (No usar alert/confirm)
                if (!window.confirm("¿Estás seguro de que quieres eliminar esta canción? Esta acción es permanente.")) return;

                try {
                    // 1. Eliminar de Storage
                    const sRef = storageRef(storage, storagePath);
                    await deleteObject(sRef);

                    // 2. Eliminar de Firestore
                    const docPath = `artifacts/${appId}/public/data/${FIREBASE_SETTINGS.storageCollection}/${songId}`;
                    await deleteDoc(doc(db, docPath));

                    displayStatus('Song deleted successfully.', 'bg-green-500');
                } catch (error) {
                    console.error("Delete Error:", error);
                    displayStatus(`Error deleting song: ${error.message}`, 'bg-red-500');
                }
            }
        });

        // Manejadores de eventos para filtrar y ordenar
        searchInput.addEventListener('input', filterAndSortSongs);
        sortRadios.forEach(radio => radio.addEventListener('change', filterAndSortSongs));


        // Función de utilidad para mostrar estado
        function displayStatus(message, className) {
            uploadStatus.textContent = message;
            uploadStatus.className = `p-3 rounded-lg text-sm mb-4 ${className} text-white font-semibold`;
            uploadStatus.classList.remove('hidden');
            setTimeout(() => {
                uploadStatus.classList.add('hidden');
            }, 5000);
        }

        // Iniciar la aplicación
        initFirebase();
    </script>
</body>
</html>
