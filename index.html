<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TWS Music Host Site</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // --- Configuraciones de Firebase y Variables Globales ---
        setLogLevel('Debug');
        
        // Variables globales (proporcionadas por el entorno de Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Inicialización y Autenticación de Firebase
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase is not configured. Database functionality will not work.");
                 return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        // console.log("User authenticated. UID:", userId); // Oculto para evitar registro en consola
                        window.setupApp(db, auth, userId, appId); 
                    } else {
                        userId = crypto.randomUUID(); 
                        isAuthReady = true;
                        window.setupApp(null, null, userId, appId);
                        // console.log("Anonymous session started. Generated ID:", userId); // Oculto para evitar registro en consola
                    }
                });

            } catch (error) {
                console.error("Error initializing or authenticating Firebase:", error);
                userId = crypto.randomUUID(); 
                isAuthReady = true;
                window.setupApp(null, null, userId, appId);
            }
        };

        window.initFirebase = initFirebase;
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; 
            color: #c9d1d9; 
        }
        .container-card {
            background-color: #161b22; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .audio-player {
            width: 100%;
            height: 40px;
            background-color: #21262d;
            border-radius: 9999px; 
        }
        input[type="file"]::-webkit-file-upload-button {
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col" onload="window.initFirebase()">

    <header class="bg-[#1f262e] border-b border-[#30363d] py-3 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-white">TWS Music Host Site</h1>
            <nav>
                <a href="#home" id="nav-home" class="text-blue-400 hover:text-blue-300 font-semibold mr-4">Home</a>
                <a href="#music-links" id="nav-links" class="text-gray-400 hover:text-white">Music Links</a>
            </nav>
        </div>
    </header>

    <main id="home" class="flex-grow flex items-center justify-center p-6">
        <div class="container-card w-full max-w-md p-8 rounded-xl">
            <h2 class="text-2xl font-semibold mb-6 text-center text-white">Upload your MP3s here</h2>
            
            <p id="user-info" class="text-xs text-center text-gray-500 mb-4 hidden">
                User ID: Loading...
            </p>
            
            <p class="text-sm text-center text-red-400 mb-6 font-bold">
                Note: Upload is handled by Cloudinary. Max. 40 MB.
            </p>

            <form id="mp3-upload-form" class="space-y-6">
                
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Password (Authentication)</label>
                    <input type="password" id="password" name="password" 
                           class="w-full px-4 py-2 rounded-lg bg-[#21262d] border border-[#30363d] focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-500"
                           placeholder="Enter access password">
                </div>

                <div>
                    <label for="mp3-file" class="block text-sm font-medium mb-1">Choose MP3 File</label>
                    <input type="file" id="mp3-file" name="mp3-file" accept="audio/mp3, audio/mpeg" required
                           class="w-full text-sm text-gray-400
                           file:mr-4 file:py-2 file:px-4
                           file:rounded-full file:border-0
                           file:text-sm file:font-semibold
                           file:bg-blue-600 file:text-white
                           hover:file:bg-blue-700">
                </div>

                <div>
                    <label for="custom-name" class="block text-sm font-medium mb-1">Custom Name</label>
                    <input type="text" id="custom-name" name="custom-name" required
                           class="w-full px-4 py-2 rounded-lg bg-[#21262d] border border-[#30363d] focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white placeholder-gray-500"
                           placeholder="Ex: duty calls">
                </div>

                <button type="submit" id="upload-button"
                        class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition duration-200 shadow-md">
                    Upload
                </button>
            </form>

            <div id="status-message" class="mt-4 text-center text-sm font-medium hidden"></div>

            <div class="mt-6 pt-4 border-t border-[#30363d] hidden">
                <h3 class="text-sm font-semibold mb-2 text-gray-400">Activity/Error Log</h3>
                <div id="activity-log" class="max-h-40 overflow-y-auto space-y-1 p-2 rounded-lg bg-[#21262d] text-xs flex flex-col-reverse">
                    <p class="text-gray-500">Application log initialized.</p>
                </div>
            </div>

        </div>
    </main>

    <section id="music-links" class="hidden flex-grow flex justify-center p-6">
        <div class="container-card w-full max-w-4xl p-8 rounded-xl h-full flex flex-col">
            <h2 class="text-2xl font-semibold mb-6 text-center text-white">Uploaded Music Links</h2>
            <p id="song-count" class="text-sm text-gray-500 mb-4 text-center">Total: Loading...</p>
            
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-center">
                <input type="text" id="search-input" placeholder="Search song by name..."
                       class="w-full sm:flex-grow px-4 py-2 rounded-lg bg-[#21262d] border border-[#30363d] text-white placeholder-gray-500 mb-4 sm:mb-0 sm:mr-4">
                <div class="flex space-x-4 text-sm whitespace-nowrap">
                    <label><input type="radio" name="sort" value="alpha" id="sort-alpha" class="mr-1"> Alphabetical</label>
                    <label><input type="radio" name="sort" value="newest" id="sort-newest" checked class="mr-1"> Newest</label>
                    <label><input type="radio" name="sort" value="oldest" id="sort-oldest" class="mr-1"> Oldest</label>
                </div>
            </div>
            
            <div id="music-list" class="space-y-3 flex-grow overflow-y-auto pr-2">
                <p id="list-status" class="text-center text-gray-500">Loading music links...</p>
            </div>

        </div>
    </section>
    
    <footer class="bg-[#1f262e] border-t border-[#30363d] py-3 px-6 text-center text-xs text-gray-500">
        &copy; 2025 by Renton. All rights reserved.
    </footer>

    <script>
        // Variables globales de Firebase (se poblarán en initFirebase)
        let dbInstance = null;
        let userId = null;
        let appId = null;
        let statusTimeout = null;
        
        const MAX_FILE_SIZE = 40 * 1024 * 1024; 

        // CLOUDINARY CONFIGURATION (Confirmed values)
        const CLOUDINARY_CLOUD_NAME = "daj3jaqd9"; 
        const CLOUDINARY_UPLOAD_PRESET = "tws_music_uploads"; 
        const PUBLIC_MUSIC_COLLECTION_PATH = 'public/data/music_links'; 

        window.setupApp = (db, auth, uid, app_id) => {
            dbInstance = db;
            userId = uid;
            appId = app_id;
            
            // document.getElementById('user-info').textContent = `User ID: ${userId}`; // Elemento oculto
            
            initAppLogic();
        };

        function displayStatus(message, type = 'info', duration = 5000) { 
            clearTimeout(statusTimeout);
            const statusMessage = document.getElementById('status-message');
            const logContainer = document.getElementById('activity-log');

            // --- 1. Temporary Status Bar ---
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');

            let colorClass = '';
            
            switch(type) {
                case 'error':
                    colorClass = 'bg-red-900 text-red-300 border-red-700';
                    duration = 0; 
                    break;
                case 'success':
                    colorClass = 'bg-green-900 text-green-300 border-green-700';
                    break;
                case 'loading':
                    colorClass = 'bg-blue-900 text-blue-300 border-blue-700';
                    duration = 0; 
                    break;
                default:
                    colorClass = 'bg-gray-700 text-gray-300 border-gray-600';
            }
            
            statusMessage.className = `mt-4 p-3 rounded-lg text-center text-sm font-medium border ${colorClass}`;
            
            if (duration > 0) {
                statusTimeout = setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, duration);
            }
            
            // --- 2. Persistent Log (still populating, though hidden for UI) ---
            const logEntry = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString();
            
            let logColorClass = 'text-gray-400';
            let prefix = 'INFO';

            switch(type) {
                case 'error':
                    logColorClass = 'text-red-300';
                    prefix = 'ERROR';
                    console.error(`[LOG] ${timestamp} ${message}`);
                    break;
                case 'success':
                    logColorClass = 'text-green-300';
                    prefix = 'SUCCESS';
                    break;
                case 'loading':
                    logColorClass = 'text-blue-300';
                    prefix = 'LOAD';
                    break;
                default:
                    logColorClass = 'text-gray-400';
                    prefix = 'INFO';
            }
            
            logEntry.className = logColorClass;
            logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}] [${prefix}]</span> ${message}`; 
            
            logContainer.prepend(logEntry);
            
            if (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }

        }
        
        function renderMusicItem(item) {
            const div = document.createElement('div');
            div.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center bg-[#21262d] p-3 rounded-lg border border-[#30363d]';
            
            const infoContainer = document.createElement('div');
            infoContainer.className = 'flex flex-col w-full sm:w-2/3 mb-2 sm:mb-0';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'truncate text-white font-medium mb-2';
            titleSpan.textContent = item.customName || 'Unassigned Name';
            
            const audioPlayer = document.createElement('audio');
            audioPlayer.controls = true;
            audioPlayer.src = item.sharedUrl;
            audioPlayer.className = 'audio-player';

            infoContainer.appendChild(titleSpan);
            infoContainer.appendChild(audioPlayer);

            const copyButton = document.createElement('button');
            copyButton.className = 'copy-link-btn w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-2 px-4 rounded-full transition duration-200 mt-2 sm:mt-0';
            copyButton.textContent = 'Copy Link';
            copyButton.dataset.url = item.sharedUrl; 

            div.appendChild(infoContainer);
            div.appendChild(copyButton);
            
            return div;
        }

        // Lógica de Renderizado y Escucha de Firestore (Puntos 7 y 10)
        function setupMusicListener() {
            if (!dbInstance) {
                document.getElementById('list-status').textContent = 'Error: Database not available. Please refresh the page.';
                displayStatus('DB Error: Database not available to listen for changes.', 'error');
                return;
            }
            
            const musicListContainer = document.getElementById('music-list');
            const collectionRef = collection(dbInstance, 'artifacts', appId, PUBLIC_MUSIC_COLLECTION_PATH);
            
            const musicQuery = query(collectionRef, orderBy('createdAt', 'desc'));
            
            // Esta función maneja la actualización de la lista en tiempo real
            const unsubscribe = onSnapshot(musicQuery, (snapshot) => {
                const songs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.sharedUrl) {
                        songs.push(data);
                    }
                });

                musicListContainer.innerHTML = '';
                document.getElementById('song-count').textContent = `Total: ${songs.length} songs`;

                if (songs.length === 0) {
                    musicListContainer.innerHTML = '<p class="text-center text-gray-500">No songs have been uploaded yet.</p>';
                    return;
                }
                
                songs.forEach(song => {
                    musicListContainer.appendChild(renderMusicItem(song));
                });

                setupCopyButtons();
                displayStatus(`${songs.length} songs list updated.`, 'info', 2000);
            }, (error) => {
                console.error("Error listening to music list:", error);
                document.getElementById('list-status').textContent = 'Error loading music list. Check permissions.';
                displayStatus(`Firestore Error: Failed to subscribe to music list.`, 'error');
            });
            
            return unsubscribe;
        }
        
        // Función para guardar el enlace en Firestore (Punto 8)
        async function saveLinkToFirestore(customName, sharedUrl) {
            if (!dbInstance) {
                 displayStatus('Error: Database is not ready to save.', 'error');
                 return false;
            }
            try {
                const path = collection(dbInstance, 'artifacts', appId, PUBLIC_MUSIC_COLLECTION_PATH);
                await addDoc(path, {
                    customName: customName,
                    sharedUrl: sharedUrl,
                    uploadedBy: userId, 
                    createdAt: serverTimestamp() 
                });
                displayStatus(`Successfully saved to Firestore. Name: ${customName}`, 'success', 3000); // Cambiado a success
                return true;
            } catch (error) {
                console.error("Error saving link to Firestore:", error);
                displayStatus(`Error saving link to DB: ${error.message}`, 'error');
                return false;
            }
        }

        // Lógica de Subida a Cloudinary (Punto 8)
        async function handleUpload(e) {
            e.preventDefault();

            if (CLOUDINARY_CLOUD_NAME === "" || CLOUDINARY_UPLOAD_PRESET === "") {
                 displayStatus('ERROR: Cloudinary configuration is incomplete. Check constants.', 'error');
                 return;
            }
            
            const fileInput = document.getElementById('mp3-file');
            const customNameInput = document.getElementById('custom-name');
            const file = fileInput.files[0];
            const customName = customNameInput.value.trim();
            
            if (!file) {
                displayStatus('Validation: Please select an MP3 file.', 'error');
                return;
            }
            if (!customName) {
                 displayStatus('Validation: Please enter a custom name.', 'error');
                 return;
            }
            
            if (file.size > MAX_FILE_SIZE) {
                 displayStatus(`Error: File is too large. Maximum ${MAX_FILE_SIZE / (1024 * 1024)} MB.`, 'error');
                 return;
            }
            if (!file.type.startsWith('audio/')) {
                 displayStatus('Error: Only audio files are allowed.', 'error');
                 return;
            }

            displayStatus('Uploading file, please wait...', 'loading');
            document.getElementById('upload-button').disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('public_id', `music/${customName.replace(/[^a-z0-9]/gi, '_')}-${Date.now()}`); 
                formData.append('resource_type', 'auto'); 
                
                const apiUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const sharedUrl = data.secure_url; 
                    displayStatus(`Cloudinary: Upload complete. Saving link...`, 'loading');
                    
                    const saved = await saveLinkToFirestore(customName, sharedUrl);

                    if (saved) {
                         displayStatus(`Success! Upload and save successful.`, 'success');
                         document.getElementById('mp3-upload-form').reset();
                    }

                } else {
                    displayStatus(`Cloudinary Upload Error: ${data.error ? data.error.message : 'Unknown error'}`, 'error');
                    console.error("Cloudinary response error:", data);
                }

            } catch (error) {
                displayStatus(`Network or Connection Error: ${error.message}`, 'error');
                console.error("Upload error:", error);
            } finally {
                document.getElementById('upload-button').disabled = false;
            }
        }
        
        function setupCopyButtons() {
            document.querySelectorAll('.copy-link-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const urlToCopy = button.dataset.url;
                    
                    const textarea = document.createElement('textarea');
                    textarea.value = urlToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        displayStatus('Link copied to clipboard: ' + urlToCopy.substring(0, 50) + '...', 'success', 3000);
                    } catch (err) {
                        displayStatus('Error attempting to copy link.', 'error');
                    }
                    document.body.removeChild(textarea);
                });
            });
        }

        // Lógica de Navegación de Pestañas (Punto 7)
        const showSection = (id) => {
            document.getElementById('home').classList.add('hidden');
            document.getElementById('music-links').classList.add('hidden');
            
            if (id === 'home') {
                document.getElementById('home').classList.remove('hidden');
            } else if (id === 'music-links') {
                document.getElementById('music-links').classList.remove('hidden');
                // Al entrar a Music Links, aseguramos que el listener esté activo
                if (dbInstance) { setupMusicListener(); }
            }
            
            // Actualizar la clase activa en la navegación
            const navLinks = document.querySelectorAll('header nav a');
            navLinks.forEach(link => {
                link.classList.remove('text-blue-400', 'font-semibold', 'hover:text-blue-300');
                link.classList.add('text-gray-400', 'hover:text-white');
                if (link.getAttribute('href') === '#' + id) {
                    link.classList.add('text-blue-400', 'font-semibold', 'hover:text-blue-300');
                    link.classList.remove('text-gray-400', 'hover:text-white');
                }
            });
        };

        function initAppLogic() {
            displayStatus('Application initialized and ready for Firebase/Cloudinary.', 'info', 3000);
            
            // Conectar el formulario a la función de subida
            document.getElementById('mp3-upload-form').addEventListener('submit', handleUpload);

            // Manejar los clics en los enlaces de navegación (Punto 7)
            const navLinks = document.querySelectorAll('header nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = link.getAttribute('href').substring(1);
                    showSection(sectionId);
                });
            });

            // Mostrar la página de inicio por defecto
            showSection('home');
        }
    </script>
</body>
</html>
```eof
